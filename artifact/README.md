# Artifact for "Specifying and Testing GPU Workgroup Progress Models"

## Abstract

TODO

## Getting started

These instructions have been tested on a 64-bit Linux machine running an OS
similar to Ubuntu 18.04 with Docker installed and with Bash as the shell. Other
configurations are likely to work since we mostly use Docker.

## Build the docker image

Change into the directory:

```sh
cd gpufwd_image/
```

Execute the following commands to build the Docker image, 
build the Docker container, and start the Docker container:

```sh
sudo docker build -t gpufwd-image .

sudo docker stop gpufwd-container  # May fail.
sudo docker rm gpufwd-container    # May fail.
sudo docker create -it --name gpufwd-container gpufwd-image

sudo docker start -ia gpufwd-container
```

You should now have a Bash shell inside the container.

## Test Generation

_TODO: Tyler and Lucas figure out how to get test generation running_

_TODO: instructions for running 2 thread 2 instruction variants_

_TODO: State that running larger experiments require tons of time and tons of RAM_

_TODO: point to Lucas Test explorer, both the Princeton hosted page and the git repo, as well as generated raw tests
> Hugues: we can probably include the html pages directly in the artifact image, for local browsing?

## CADP: model-checking test termination

In Section 4 "Executable Semantics of Progress Models", we describe how we use
the CADP verification toolbox to automatically check whether a given litmus test
is guaranteed to terminate under various progress models. Here we describe how
to install CADP, and how to run our scripts that use CADP to do the
verification.

### CADP install

CADP is a closed-source research software that requires a license to run, and as
such it was not possible for us to embed it in this artifact.

To install CADP and get a license, see:
https://cadp.inria.fr/registration/

Academic users can obtain a personal, free-of-charge license.

Our experiments are known to work with CADP version `2020-l`, please make sure
to install this version.

For users who cannot easily obtain CADP, we still provide a standalone example
that shows CADP input and output files, to illustrate how we use the toolbox and
how it lets us check for test 5~termination.

### Standalone example: mutex litmus test

We use the article's running example of two threads competing for a mutex as a
standalone example.

We have two types of input files to CADP:

 - `*.lnt` files represent models written in the LNT formal language.
 
 - `*.svl` files represent verification scenarios written in the script
   verification language (SVL), where we typically check properties expressed in
   the model checking language (MCL) on some model written in LNT.

The `cadp/mutex-standalone-example/` directory contains the following files.

`mutex.lnt` is the LNT model of our mutex example. In this file we find the
definition of the various types and processes needed to express our litmus
tests, including the definition of the progress models. These LNT sources are
the basis for the LNT listings of the article, where they are only slightly
edited to be shorter and remove small and irrelevant implementation details.

Most of the code of `mutex.lnt` is generic, only the AXB instructions given in
argument to the INTERPRETER processes are specific to the mutex example. For the
sake of simplicity in this standalone example, we decided to keep everything in
a single file containing both generic code and the mutex-specific AXB programs.

`verif.svl` contains the SVL verification script with the MCL formulas used to
check deadlocks under both weak and strong fairness, as discussed in the
article. Similar to LNT listings, the MCL formulas listed in the article have
been only slightly edited in order to ease their presentation.

`labels.rename` is a utility file used to work around a limitation of CADP
concerning the formatting of values of sets of naturals, and how they can be
referred to in MCL formulas. This is an implementation detail that can be
ignored.

On a machine with CADP installed, you can run the verification procedure with:

```sh
cd cadp/mutex-standalone-example/
svl
```

This generates the state space of the mutex example for all our progress models,
and check the presence of potential deadlocks. It should produce a log similar
to `expected_output.log`.

We also include a series of PDFs that represent the LTSs obtained for various
progress models. On a machine with CADP installed, the commands to reproduce
such PDFs are:

```sh
# You can change OBE with any other progress model name
lnt.open -root MAIN_OBE mutex.lnt generator m_OBE.bcg
bcg_labels -rename -total labels.rename m_OBE.bcg mutex_OBE.bcg
bcg_min mutex_OBE.bcg
bcg_draw -ps mutex_OBE.bcg
ps2pdf mutex_OBE.ps
```

### Processing the tests generated by Alloy

We have scripts to automatically process the litmus tests obtained with Alloy.

These scripts take files produced by Alloy as an input, generate LNT and SVL
files, call CADP tools on them, and process the results. The top-level script is
`cadp/scripts/process.sh`. On a machine with CADP installed, we can reproduce
our experiments with these commands:

```sh
cd cadp/
./scripts/process.sh 2_threads_2_instructions
./scripts/process.sh 2_threads_3_instructions
./scripts/process.sh 2_threads_4_instructions
./scripts/process.sh 3_threads_3_instructions
./scripts/process.sh 3_threads_4_instructions
```

### timings

#### 2t2i

real    14m24.671s
user    9m45.832s
sys     6m21.656s

#### 2t3i

real    320m19.241s
user    216m53.571s
sys     142m21.101s


#### 2t4i

real    314m27.747s
user    212m44.130s
sys     139m57.769s

#### 3t3i

real    38m32.482s
user    25m59.678s
sys     17m2.172s

#### 3t4i

real    194m3.329s
user    130m55.362s
sys     86m0.682s


This results in 


check termination of the litmus tests obtained via
Alloy. These scripts automatically generate LNT and SVL files, call CADP tools
on them, and process the results. The top-level script is
`cadp/scripts/process.sh`.

On a machine where CADP is installed, 

Hugues: TODO once we have the test generation in a good shape.



_TODO: Hugues_

At the core, we have the LNT spec that's parametrized by test programs.

Ship one stand-alone example.

Then explain that we have scripts to generate litmus test programs in their LNT
forms from the ones produced by Alloy.

How to get CADP with a license.

Ship C code?

## Emprical Testing

### C++ Code

_TODO: Tyler: this should work_

### Vulkan Code

_TODO: Tyler: install amber and switftshader_

### CUDA and Metal Code

_TODO: Tyler: will not be able to execute, but we can provide the xcode projects_

## Data

_TODO: Tyler_
